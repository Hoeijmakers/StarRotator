#include <stdio.h>
#include <math.h>
#include <errno.h>
#include "spectrum.h"

float he4471_12(T,wave)
double T,wave;
{
 double DL,p1,p2;
 int i,j,k;
 static int l = 0;
 static float dl[33] = {-2.00,-1.50,-1.00,-0.80,-0.60,-0.50,-0.40,-0.30,-0.25,
		 -0.20,-0.15,-0.10,-0.06,-0.04,-0.02,-0.01,0.00,0.01,0.02,
		  0.04,0.06,0.10,0.15,0.20,0.25,0.30,0.40,0.50,0.60,0.80,
		  1.00,1.50,2.00};
 static float t[4] = {5000.0,10000.0,20000.0,40000.0};
 static float b1[4] = {4.85e-16,4.77e-16,4.68e-16,4.57e-16};
 static float b2[4] = {3.72e-16,3.71e-16,3.77e-16,3.89e-16};
 static float prof[33][4] = {{7.66e-06,7.52e-06,7.39e-06,7.22e-06},
 {1.35e-05,1.32e-05,1.29e-05,1.27e-05},{2.97e-05,2.91e-05,2.87e-05,2.89e-05},
 {4.60e-05,4.51e-05,4.50e-05,4.66e-05},{8.08e-05,8.04e-05,8.22e-05,2.64e-04},
 {1.16e-04,1.17e-04,1.28e-04,3.55e-03},{1.83e-04,1.88e-04,9.36e-04,3.91e-02},
 {3.34e-04,7.13e-04,3.24e-02,2.58e-01},{5.10e-04,7.40e-03,1.42e-01,5.43e-01},
 {2.31e-03,7.87e-02,4.79e-01,9.98e-01},{6.58e-02,5.17e-01,1.23e+00,1.60e+00},
 {9.59e-01,2.00e+00,2.42e+00,2.25e+00},{3.82e+00,3.98e+00,3.42e+00,2.67e+00},
 {5.88e+00,4.94e+00,3.81e+00,2.82e+00},{7.62e+00,5.63e+00,4.07e+00,2.91e+00},
 {8.13e+00,5.81e+00,4.14e+00,2.93e+00},{8.30e+00,5.88e+00,4.16e+00,2.94e+00},
 {8.13e+00,5.81e+00,4.14e+00,2.93e+00},{7.62e+00,5.63e+00,4.07e+00,2.91e+00},
 {5.88e+00,4.94e+00,3.81e+00,2.82e+00},{3.81e+00,3.98e+00,3.42e+00,2.67e+00},
 {9.58e-01,1.99e+00,2.42e+00,2.25e+00},{6.57e-02,5.17e-01,1.23e+00,1.60e+00},
 {2.28e-03,7.87e-02,4.79e-01,9.98e-01},{4.86e-04,7.39e-03,1.42e-01,5.43e-01},
 {3.12e-04,7.03e-04,3.24e-02,2.58e-01},{1.66e-04,1.77e-04,9.33e-04,3.91e-02},
 {1.04e-04,1.08e-04,1.23e-04,3.56e-03},{7.06e-05,7.26e-05,7.72e-05,2.63e-04},
 {3.89e-05,3.98e-05,4.09e-05,4.43e-05},{2.46e-05,2.48e-05,2.54e-05,2.68e-05},
 {1.05e-05,1.08e-05,1.08e-05,1.12e-05},{5.88e-06,5.87e-06,5.96e-06,6.16e-06}};

 if(T <= 5000.0) T = 5000.1;
 if(T >= 40000.0) T = 39999.9;

 DL = wave - 4471.48;

 for(i=0;i<3;i++) {
   if(T >= t[i] && T < t[i+1]) {
     k = i;
     break;
   }
 }

 if(DL <= -2.00) {
   p1 = b1[k]*pow(4471.48+DL,3.0)*pow(-DL,-2.5);
   p2 = b1[k+1]*pow(4471.48+DL,3.0)*pow(-DL,-2.5);
   return(p1 + (p2 - p1)*(T-t[k])/(t[k+1]-t[k]));
 }

 if(DL >= 2.00) {
   p1 = b2[k]*pow(4471.48+DL,3.0)*pow(DL,-2.5);
   p2 = b2[k+1]*pow(4471.48+DL,3.0)*pow(DL,-2.5);
   return(p1 + (p2 - p1)*(T-t[k])/(t[k+1]-t[k]));
 }

 for(j=l;j<32;j++) {
   if(DL > dl[j] && DL <= dl[j+1]) {
     l = j;
     break;
   }
 }

 p1 = prof[l][k] + (prof[l][k+1]-prof[l][k])*(T-t[k])/(t[k+1]-t[k]);
 p2 = prof[l+1][k] + (prof[l+1][k+1]-prof[l+1][k])*(T-t[k])/(t[k+1]-t[k]);
 return(p1 + (p2-p1)*(DL-dl[l])/(dl[l+1]-dl[l]));
}


