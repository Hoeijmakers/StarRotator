#include <math.h>
#include <errno.h>
#include <stdio.h>
#include "spectrum.h"
double unified();
double dmax();
double dmin();
int imin();
double pgffactor();
int Nmax();
double pcutoff();

void paschen(hkap,model,wave)
atmosphere *model;
double hkap[];
double wave;
{
   static double w0[] =
		 {18750.954,12818.028,10938.047,10049.328,9545.928,9228.972,
		   9014.868, 8862.742, 8750.431, 8664.977,8598.351,8545.342,
		   8502.442, 8467.213, 8437.915, 8413.277,8392.356,8374.435,
		   8358.963, 8345.512, 8333.742, 8323.384,8314.220,8306.072,
		   8298.794, 8292.267, 8286.391, 8281.082,8276.268,8271.890,
		   8267.897, 8264.244, 8260.895, 8257.815,8254.978,8252.358,
		   8249.933, 8247.685, 8245.597, 8243.653,8241.841,8240.150,
		   8238.568, 8237.087, 8235.698, 8234.393,8233.167,8232.012,
		   8230.923, 8229.896, 8228.925, 8228.007,8227.138,8226.315,
		   8225.534, 8224.792, 8224.087, 8223.417,8222.779,8222.171,
		   8221.592, 8221.039, 8220.512, 8220.007,8219.525,8219.064,
		   8218.622, 8218.199, 8217.794, 8217.405,8217.032,8216.674,
		   8216.329, 8215.999, 8215.680, 8215.374,8215.079,8214.796,
		   8214.522, 8214.258, 8214.004, 8213.759,8213.522,8213.293,
		   8213.072, 8212.859, 8212.652, 8212.453,8212.259,8212.072,
		   8211.891, 8211.716, 8211.546, 8211.381,8211.222,8211.067,
		   8210.917, 8210.771, 8210.630, 8210.492,8210.359,8210.229,
		   8210.103, 8209.981, 8209.862, 8209.746,8209.633,8209.524,
		   8209.417, 8209.313, 8209.212, 8209.114,8209.018,8208.924,
		   8208.833, 8208.744, 8208.657, 8208.573,8208.490,8208.410,
		   8208.332, 8208.255, 8208.180, 8208.107,8208.036,8207.966,
		   8207.898, 8207.832, 8207.767, 8207.703,8207.641,8207.580,
		   8207.521, 8207.463, 8207.406, 8207.350,8207.296,8207.242,
		   8207.190, 8207.139, 8207.089, 8207.040,8206.992,8206.945,
		   8206.899, 8206.854, 8206.810, 8206.766,8206.724,8206.682,
		   8206.641, 8206.601, 8206.562, 8206.523,8206.486,8206.448,
		   8206.412, 8206.376, 8206.341, 8206.307,8206.273,8206.240,
		   8206.207, 8206.175, 8206.144, 8206.113,8206.083,8206.053,
		   8206.023, 8205.995, 8205.966, 8205.939,8205.911,8205.884,
		   8205.858, 8205.832, 8205.806, 8205.781,8205.757,8205.732,
		   8205.708, 8205.685, 8205.662, 8205.639,8205.616,8205.594,
		   8205.573, 8205.551, 8205.530, 8205.510,8205.489,8205.469,
		   8205.449, 8205.430, 8205.411, 8205.392,8205.373,8205.355,
		   8205.337, 8205.319, 8205.301, 8205.284,8205.267,8205.250,
		   8205.234, 8205.218, 8205.202, 8205.186,8205.170,8205.155,
		   8205.139, 8205.125, 8205.110, 8205.095,8205.081,8205.067,
		   8205.053, 8205.039, 8205.025, 8205.012,8204.999,8204.986,
		   8204.973, 8204.960, 8204.948, 8204.935,8204.923,8204.911,
		   8204.899, 8204.887, 8204.876, 8204.864,8204.853,8204.842,
		   8204.831, 8204.820, 8204.809, 8204.798,8204.788,8204.778,
		   8204.767, 8204.757, 8204.747, 8204.737,8204.728,8204.718};
   static double Ehigh[] =
		    {12.74607,13.05198,13.21815,13.31834,13.38338,13.42796,
		     13.45985,13.48345,13.50139,13.51536,13.52644,13.53538,
		     13.54270,13.54877,13.55385,13.55815,13.56182,13.56498,
		     13.56772,13.57011,13.57221,13.57406,13.57570,13.57716,
		     13.57847,13.57964,13.58070,13.58166,13.58252,13.58333,
		     13.58405,13.58471,13.58532,13.58588,13.58639,13.58687,
		     13.58731,13.58772,13.58810,13.58846,13.58879,13.58910,
		     13.58938,13.58966,13.58991,13.59015,13.59037,13.59058,
		     13.59078,13.59097,13.59115,13.59132,13.59147,13.59163,
		     13.59177,13.59190,13.59203,13.59216,13.59227,13.59238,
		     13.59249,13.59259,13.59269,13.59278,13.59287,13.59295,
		     13.59304,13.59311,13.59319,13.59326,13.59333,13.59339,
		     13.59346,13.59352,13.59358,13.59363,13.59369,13.59374,
		     13.59379,13.59384,13.59388,13.59393,13.59397,13.59401,
		     13.59405,13.59409,13.59413,13.59417,13.59420,13.59424,
		     13.59427,13.59430,13.59433,13.59436,13.59439,13.59442,
		     13.59445,13.59448,13.59450,13.59453,13.59455,13.59458,
		     13.59460,13.59462,13.59464,13.59467,13.59469,13.59471,
		     13.59473,13.59475,13.59476,13.59478,13.59480,13.59482,
		     13.59483,13.59485,13.59487,13.59488,13.59490,13.59491,
		     13.59493,13.59494,13.59495,13.59497,13.59498,13.59499,
		     13.59501,13.59502,13.59503,13.59504,13.59505,13.59506,
		     13.59507,13.59509,13.59510,13.59511,13.59512,13.59513,
		     13.59514,13.59515,13.59515,13.59516,13.59517,13.59518,
		     13.59519,13.59520,13.59521,13.59521,13.59522,13.59523,
		     13.59524,13.59524,13.59525,13.59526,13.59527,13.59527,
		     13.59528,13.59529,13.59529,13.59530,13.59530,13.59531,
		     13.59532,13.59532,13.59533,13.59533,13.59534,13.59534,
		     13.59535,13.59536,13.59536,13.59537,13.59537,13.59538,
		     13.59538,13.59539,13.59539,13.59539,13.59540,13.59540,
		     13.59541,13.59541,13.59542,13.59542,13.59543,13.59543,
		     13.59543,13.59544,13.59544,13.59544,13.59545,13.59545,
		     13.59546,13.59546,13.59546,13.59547,13.59547,13.59547,
		     13.59548,13.59548,13.59548,13.59549,13.59549,13.59549,
		     13.59550,13.59550,13.59550,13.59550,13.59551,13.59551,
		     13.59551,13.59552,13.59552,13.59552,13.59552,13.59553,
		     13.59553,13.59553,13.59553,13.59554,13.59554,13.59554,
		     13.59554,13.59555,13.59555,13.59555,13.59555,13.59556,
		     13.59556,13.59556,13.59556,13.59556,13.59557,13.59557,
		     13.59557,13.59557,13.59557,13.59558,13.59558,13.59558,
		     13.59558,13.59558,13.59559,13.59559,13.59559,13.59559};
   extern float **bkap;
   int i,j,m,ifcore;
   double *wave0,*Eh;
   static double fac = 4.0;
   float rad = 400.0;
   double minrad = 1.0;
   static double lambda[4] = {9000.0,9000.0,9000.0,9000.0};
   static int nmax[NTAU];
   static double Cutoff[NTAU];
   static int flag = 0;
   static int flag1 = 0;
   static double cut;
   double cutmax,cutmin;
   static double gffac4[251];
   double *gffac;
   extern int Ntau;
   extern memo reset;
   int NM = 250;


   gffac = gffac4-4;
   ifcore = 0;
   wave0 = w0-4;
   Eh = Ehigh-4;
   if(reset.paschen == 1) {
     flag = 0;
     reset.paschen = 0;
   }

   if(wave < 8203.601 || wave > 18951.0) return;
   if(flag1 == 0) {
     for(i=0;i<Ntau;i++) {
       Cutoff[i] = pcutoff(model->T[i],model->Ne[i],&NM);
       nmax[i] = NM;
     }
     for(m=4;m<250;m++) gffac[m] = pgffactor(m);
     flag1 = 1;
   }

   for(m=4;m<250;m++) {
     if(fabs(wave - wave0[m]) < 5.0) ifcore = 1;
   }

   if(ifcore == 0 && flag == 0) {
	lambda[1] = floor(wave);
	lambda[0] = lambda[1] - 1.0;
	lambda[2] = lambda[1] + 1.0;
	lambda[3] = lambda[1] + 2.0;
	for(i=0;i<Ntau;i++) {
	  bkap[0][i] = bkap[1][i] = bkap[2][i] = bkap[3][i] = 0.0;
	}
	for(m=4;m<250;m++) {
/*	  rad = fac*(wave0[m] - wave0[m+1]);
	  rad = dmin(200.0,rad);
	  if(rad < minrad) rad = minrad;  */
	  if(fabs(wave - wave0[m]) < rad) {
	    for(i=0;i<Ntau;i++) {
	      if(m > nmax[i] || wave < Cutoff[i]) continue;
	      for(j=0;j<4;j++) bkap[j][i] += gffac[m]*
			unified(3,m,i,12.08716,Eh[m],model,lambda[j]);
	    }
	  }
	}
	flag = 1;
   }


   if(ifcore == 0 && wave >= lambda[2]) {
     for(j=0;j<4;j++) lambda[j] += 1.0;
       for(i=0;i<Ntau;i++) {
	 for(j=0;j<3;j++) bkap[j][i] = bkap[j+1][i];
	 bkap[3][i] = 0.0;
       }
       for(m=4;m<250;m++) {
/*	 rad = fac*(wave0[m] - wave0[m+1]);
	 rad = dmin(200.0,rad);
	 if(rad < minrad) rad = minrad; */
	 if(fabs(wave-wave0[m]) < rad) {
	   for(i=0;i<Ntau;i++) {
	     if(m > nmax[i] || wave < Cutoff[i]) continue;
	     bkap[3][i] += gffac[m]*
			unified(3,m,i,12.08716,Eh[m],model,lambda[3]);
	   }
	 }
       }
   }

   if(ifcore == 0) {
     for(i=0;i<Ntau;i++) {
       hkap[i] = bkap[3][i]*((wave-lambda[0])*
	     (wave-lambda[1])*(wave-lambda[2]))/6.0 -
	     bkap[0][i]*((wave-lambda[1])*
	     (wave-lambda[2])*(wave-lambda[3]))/6.0 +
	     bkap[1][i]*((wave-lambda[0])*
	     (wave-lambda[2])*(wave-lambda[3]))/2.0 -
	     bkap[2][i]*((wave-lambda[0])*
	     (wave-lambda[1])*(wave-lambda[3]))/2.0;
       }
   }
   if(ifcore == 1) {
     for(i=0;i<Ntau;i++) hkap[i] = 0.0;
     for(m=4;m<250;m++) {
/*     rad = fac*(wave0[m] - wave0[m+1]);
       rad = dmin(200.0,rad);
       if(rad < minrad) rad = minrad;  */
       if(fabs(wave - wave0[m]) < rad) {
	     for(i=0;i<Ntau;i++) {
	       if(m > nmax[i] || wave < Cutoff[i]) continue;
	       hkap[i] +=  gffac[m]*
			     unified(3,m,i,12.08716,Eh[m],model,wave);
	     }
       }
     }
     flag = 0;
   }
}

double pgffactor(m)
int m;
{
  return(1.0);
/*  if(m < 14) return(1.0);
  else if(m == 14) return(0.9);
  else if(m == 15) return(0.8);
  else if(m == 16) return(0.7);
  else return(0.6);  */

/*if(m < 20) return(1.0);
  if(m == 20) return(1.2);
  if(m == 21) return(1.4);
  if(m == 22) return(1.6);
  if(m == 23) return(1.8);
  if(m == 24) return(2.0);
  if(m > 24) return(2.0); */
}

double pcutoff(T,Ne,nm)
double Ne,T;
int *nm;
{
  double Eion = 109678.758;
  double E250 = 109677.003;
  double dE;
  double Cutoff;
  double fac = 1.0;

  /* Calculate lowering of ionization potential using Unsold Approx */
/* fac = sqrt(10000.0/T); */

  dE = 5.61e-03*fac*pow(Ne,1.0/3.0);
  *nm = Nmax(Eion - dE);
  dE = dmax(dE,Eion - E250);

  Cutoff = 1.0e+08/(12186.529 - dE) - 2.181;
  return(Cutoff);
}


