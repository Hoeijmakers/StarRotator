#include <math.h>
#include "spectrum.h"
struct broadparam {
  float linecenter;
  float w[5];
  float dw[5];
  float alpha[5];
  float sig[5];
};
double jxas_01();
double jxas_02();
double jxas_03();
double jxas_04();
double jxas_05();
double jx();
void broadparam();
int approx();
double heprof();

void broadparam(linecenter,Ne,T,w,dw,a,sig)
double linecenter,Ne,T,*w,*dw,*a,*sig;
{
  static struct broadparam helium[31] = {
  {2829.07,{197.9,229.1,251.4,267.5,276.5},{0.73,0.80,0.87,0.95,1.05},
	   {0.31,0.28,0.26,0.25,0.24},{300.9,246.3,191.2,143.8,105.1}},
  {2945.10,{70.6,79.8,83.7,85.9,85.5},{0.76,0.71,0.65,0.61,0.62},
	   {0.31,0.28,0.27,0.27,0.27},{99.1,79.1,58.7,42.6,30.0}},
  {3187.74,{33.2,35.8,36.2,34.7,31.7},{0.70,0.49,0.36,0.27,0.21},
	   {0.40,0.38,0.38,0.39,0.41},{79.4,60.3,43.7,29.5,19.1}},
  {3354.55,{1500.0,1925.0,2262.5,2639.5,3129.5},{0.49,0.77,1.00,1.14,1.20},
	   {0.19,0.16,0.14,0.12,0.11},{1622.4,1472.2,1223.5,1009.3,846.2}},
  {3447.59,{337.5,415.0,459.0,477.5,484.0},{-0.26,-0.25,-0.40,-0.54,-0.71},
	   {0.30,0.25,0.24,0.23,0.23},{345.6,300.5,235.0,172.9,123.9}},
  {3613.64,{206.0,225.0,232.0,233.5,233.5},{-0.45,-0.51,-0.61,-0.70,-0.82},
	   {0.20,0.19,0.18,0.18,0.18},{192.0,148.3,108.1,76.9,54.4}},
  {3652.00,{4161.0,6264.0,8580.0,11090.0,13190.0},{0.01,0.36,0.69,0.84,1.00},
	   {0.15,0.11,0.09,0.07,0.06},{3797.2,4042.1,3914.9,3578.1,3009.2}},
  {3705.00,{765.5,1048.0,1463.0,1880.0,1795.0},{0.46,0.47,0.49,0.72,1.20},
	   {0.34,0.27,0.21,0.17,0.18},{678.7,657.0,648.6,589.3,397.9}},
  {3819.60,{375.5,559.5,787.5,820.5,710.0},{-0.19,-0.09,0.18,0.72,1.14},
	   {0.30,0.22,0.17,0.17,0.19},{313.3,330.0,328.5,242.0,148.1}},
  {3867.50,{177.9,192.0,201.6,210.0,211.5},{1.15,1.23,1.19,1.09,1.02},
	   {0.46,0.43,0.42,0.41,0.40},{144.7,110.5,82.0,60.4,43.0}},
  {3888.65,{10.6,11.7,12.3,12.2,11.7},{0.73,0.50,0.34,0.24,0.17},
	   {0.22,0.21,0.20,0.20,0.21},{17.0,13.5,9.77,6.92,4.68}},
  {3926.53,{1792.3,1678.2,1476.4,1255.4,1039.3},{0.71,0.55,0.45,0.37,0.32},
	   {0.36,0.38,0.42,0.47,0.55},{1412.0,933.3,588.8,346.7,204.2}},
  {3935.91,{76.6,1331.0,5068.0,8920.2,12822.7},{1.36,0.09,0.02,0.01,0.01},
	   {3.77,0.44,0.16,0.11,0.08},{60.2,739.4,1990.9,2477.8,2518.6}},
  {3964.73,{110.,102.,92.5,80.9,68.2},{-0.65,-0.54,-0.45,-0.37,-0.31},
	   {0.84,0.89,0.96,1.06,1.21},{170.,112.,72.4,44.7,26.3}},
  {4009.27,{2126.5,2615.5,3550.0,4650.0,5515.0},{0.49,0.79,0.84,0.92,1.15},
	   {0.18,0.15,0.12,0.1 ,0.09},{1610.1,1400.4,1344.0,1244.8,1044.0}},
  {4023.97,{407.4,579.4,760.6,1016.8,1491.3},{0.16,0.13,0.1 ,0.07,0.04},
	   {0.60,0.46,0.38,0.30,0.23},{306.2,308.0,285.8,270.2,280.2}},
  {4026.2, {621.7,502.3,399.2,313.3,243.4},{0.31,0.28,0.25,0.22,0.20},
	   {0.09,0.11,0.13,0.16,0.19},{467.7,269.2,151.4,83.2,45.7}},
  {4120.8, {82.9,98.4,108.,111.,105.},{1.38,1.14,0.91,0.73,0.59},
	   {0.55,0.49,0.45,0.45,0.46},{120.,100.,77.6,56.2,38.0}},
  {4143.76,{458.0,777.5,1079.5,1117.0,987.0},{0.20,0.11,0.21,0.66,1.19},
	   {0.29,0.20,0.15,0.15,0.16},{324.6,389.7,382.6,279.9,174.9}},
  {4168.97,{346.5,387.0,419.0,437.5,437.5},{0.98,1.06,1.08,1.11,1.15},
	   {0.35,0.33,0.31,0.30,0.30},{242.6,191.6,146.7,108.3,76.6}},
  {4387.93,{341.5,521.0,594.0,573.0,493.0},{0.19,0.18,0.54,0.96,1.38},
	   {0.17,0.12,0.11,0.11,0.13},{215.9,232.9,187.7,128.1,77.9}},
  {4437.55,{148.,168.,176.,172.,158.},{1.23,0.99,0.79,0.64,0.52},
	   {0.62,0.56,0.54,0.55,0.59},{182.,148.,110.,75.9,49.0}},
  {4713.2, {35.5,43.0,49.0,51.9,51.2},{1.49,1.25,1.02,0.82,0.66},
	   {0.38,0.33,0.30,0.28,0.29},{38.9,33.1,26.9,20.0,14.1}},
  {4921.93,{231.2,196.3,162.4,131.5,131.5},{0.39,0.34,0.30,0.26,0.26},
	   {0.09,0.08,0.08,0.09,0.10},{116.6,92.7,65.2,41.7,25.0}},
  {5015.68,{40.1,37.9,35.2,31.9,28.0},{-0.69,-0.58,-0.49,-0.40,-0.33},
	   {0.47,0.49,0.52,0.56,0.62},{38.9,25.7,17.0,11.0,6.76}},
  {5047.74,{65.0,75.5,81.7,82.3,77.9},{1.32,1.09,0.88,0.71,0.58},
	   {0.43,0.38,0.36,0.36,0.37},{61.7,51.3,38.9,27.5,18.6}},
  {5875.7, {16.5,17.6,18.1,18.0,17.3},{-0.60,-0.33,-0.13,-0.02,0.03},
	   {0.20,0.19,0.18,0.18,0.19},{11.7,8.71,6.46,4.47,3.02}},
  {6678.15,{47.3,46.3,44.9,43.9,43.6},{0.65,0.60,0.56,0.51,0.45},
	   {0.45,0.48,0.52,0.56,0.62},{24.5,15.5,10.0,6.31,3.98}},
  {7065.19,{18.2,22.5,26.5,29.3,30.3},{1.59,1.37,1.14,0.91,0.72},
	   {0.23,0.20,0.18,0.16,0.16},{8.91,7.76,6.46,5.01,3.72}},
  {7281.35,{32.5,38.9,43.6,45.8,44.9},{1.43,1.20,0.98,0.78,0.63},
	   {0.26,0.23,0.21,0.20,0.21},{14.8,12.6,10.0,7.41,5.13}},
  {8361.77,{1133.0,1364.0,1581.0,1720.0,1719.5},{0.68,0.62,0.64,0.71,0.74},
	   {0.43,0.37,0.33,0.31,0.31},{197.2,167.9,137.6,105.9,74.8}}};

  static double t[5] = {5000.0,10000.0,20000.0,40000.0,80000.0};

  int i,j,k;
  j = 30;
  for(i=0;i<31;i++) {
    if(approx(linecenter,helium[i].linecenter,0.02) == 1) {
      j = i;
      break;
    }
  }
  if(T < 5000.0) T = 5000.1;
  k = 3;
  for(i=0;i<4;i++) {
    if(T < t[i+1]) {
      k = i;
      break;
    }
  }
  *w = helium[j].w[k] + (helium[j].w[k+1]-helium[j].w[k])*
			(T-t[k])/(t[k+1]-t[k]);
  *dw = helium[j].dw[k] + (helium[j].dw[k+1]-helium[j].dw[k])*
			(T-t[k])/(t[k+1]-t[k]);
  *a = helium[j].alpha[k] + (helium[j].alpha[k+1]-helium[j].alpha[k])*
			(T-t[k])/(t[k+1]-t[k]);
  *sig = helium[j].sig[k] + (helium[j].sig[k+1]-helium[j].sig[k])*
			(T-t[k])/(t[k+1]-t[k]);
  *w = (*w)*Ne/1.0e+18;
  *a = (*a)*pow(Ne/1.0e+18,0.25);
  *sig = (*sig)*pow(Ne/1.0e+18,(4.0/3.0));
}


double heprof(linecenter,wave,n,He,k)
double linecenter,wave;
Helium *He;
int n,k;
{
  double w,sig,dw,a,omega;
  w = He[k].w[n];
  dw = He[k].dw[n];
  a = He[k].a[n];
  sig = He[k].sig[n];

  omega = (wave - linecenter)/w + dw;
  return(jx(omega,a,sig)/w);
}


double jx(w,a,sig)
double w,a,sig;
{
  double (*pf[5])() = {jxas_01,jxas_02,jxas_03,jxas_04,jxas_05};
  double alpha[5] = {0.1,0.2,0.3,0.4,0.5};
  double p1,p2;
  int i,k;

  if(a <= 0.1) return(jxas_01(w,sig));
  if(a >= 0.5) return(jxas_05(w,sig));
  k = 3;
  for(i=0;i<4;i++) {
    if(a < alpha[i+1]) {
      k = i;
      break;
    }
  }

  p1 = pf[k](w,sig);
  p2 = pf[k+1](w,sig);
  return(p1 + (p2-p1)*(a-alpha[k])/(alpha[k+1] - alpha[k]));
}


double jxas_01(w,sig)
double w,sig;
{
  double recipsig,p1,p2;
  static double we[17] = {-2.0,-1.5,-1.0,-0.7,-0.5,-0.3,-0.2,-0.1,0.0,0.1,0.2,0.3,
  0.5,0.7,1.0,1.5,2.0};
  static double j[17][2] = {{0.050,0.052},{0.073,0.073},{0.115,0.111},
  {0.154,0.148},{0.186,0.173},{0.218,0.200},{0.235,0.214},{0.247,0.226},
  {0.260,0.239},{0.270,0.251},{0.274,0.259},{0.274,0.265},{0.263,0.261},
  {0.240,0.242},{0.198,0.204},{0.134,0.142},{0.092,0.096}};
  int i,k;

  recipsig = 1.0/sig;

  if(w <= -2.0) {
    p1 = j[0][0]*4.0/(w*w);
    p2 = j[0][1]*4.0/(w*w);
    if(recipsig > 1.6667) return(p2);
    return(p1 + (p2-p1)*recipsig);
  }
  if(w >= 2.0) {
    p1 = j[16][0]*4.0/(w*w);
    p2 = j[16][1]*4.0/(w*w);
    if(recipsig >= 1.0) return(p2);
    return(p1 + (p2-p1)*recipsig);
  }
  k = 15;
  for(i=0;i<16;i++) {
    if(w < we[i+1]) {
      k = i;
      break;
    }
  }
  if(recipsig >= 1.0) {
    p1 = j[k][1] + (j[k+1][1] - j[k][1])*(w-we[k])/(we[k+1]-we[k]);
    return(p1);
  }

  p1 = j[k][0] + (j[k+1][0] - j[k][0])*(w-we[k])/(we[k+1]-we[k]);
  p2 = j[k][1] + (j[k+1][1] - j[k][1])*(w-we[k])/(we[k+1]-we[k]);
  return(p1 + (p2-p1)*recipsig);
}


double jxas_02(w,sig)
double w,sig;
{
  double recipsig,p1,p2;
  static double we[17] = {-2.0,-1.5,-1.0,-0.7,-0.5,-0.3,-0.2,-0.1,0.0,0.1,0.2,0.3,
  0.5,0.7,1.0,1.5,2.0};
  static double recip[3] = {0.0,1.0,1.66667};
  static double j[17][3] = {{0.039,0.039,0.044},{0.056,0.056,0.058},
  {0.088,0.084,0.083},{0.116,0.110,0.103},{0.143,0.130,0.121},
  {0.169,0.153,0.141},{0.183,0.166,0.150},{0.196,0.180,0.161},
  {0.208,0.193,0.172},{0.220,0.205,0.182},{0.228,0.217,0.194},
  {0.234,0.227,0.204},{0.238,0.238,0.219},{0.228,0.231,0.223},
  {0.206,0.215,0.211},{0.156,0.167,0.171},{0.114,0.121,0.127}};
  int i,k,l;

  recipsig = 1.0/sig;
  l = 1;
  for(i=0;i<2;i++) {
    if(recipsig < recip[i+1]) {
      l = i;
      break;
    }
  }

  if(w <= -2.0) {
    p1 = j[0][l]*4.0/(w*w);
    p2 = j[0][l+1]*4.0/(w*w);
    if(recipsig > 1.66667) return(p2);
    return(p1 + (p2-p1)*(recipsig-recip[l])/(recip[l+1]-recip[l]));
  }
  if(w >= 2.0) {
    p1 = j[16][l]*4.0/(w*w);
    p2 = j[16][l+1]*4.0/(w*w);
    if(recipsig > 1.66667) return(p2);
    return(p1 + (p2-p1)*(recipsig-recip[l])/(recip[l+1]-recip[l]));
  }
  k = 15;
  for(i=0;i<16;i++) {
    if(w < we[i+1]) {
      k = i;
      break;
    }
  }
  if(recipsig > 1.6667) {
    p1 = j[k][l+1] + (j[k+1][l+1] - j[k][l+1])*(w-we[k])/(we[k+1]-we[k]);
    return(p1);
  }

  p1 = j[k][l] + (j[k+1][l] - j[k][l])*(w-we[k])/(we[k+1]-we[k]);
  p2 = j[k][l+1] + (j[k+1][l+1] - j[k][l+1])*(w-we[k])/(we[k+1]-we[k]);
  return(p1 + (p2-p1)*(recipsig-recip[l])/(recip[l+1]-recip[l]));
}


double jxas_03(w,sig)
double w,sig;
{
  double recipsig,p1,p2;
  static double we[17] = {-2.0,-1.5,-1.0,-0.7,-0.5,-0.3,-0.2,-0.1,0.0,0.1,0.2,0.3,
  0.5,0.7,1.0,1.5,2.0};
  static double recip[4] = {0.0,1.0,1.66667,3.33333};
  static double j[17][4] = {{0.030,0.032,0.036,0.041},
  {0.042,0.045,0.049,0.055},{0.062,0.067,0.071,0.075},
  {0.082,0.087,0.089,0.091},{0.098,0.103,0.104,0.105},
  {0.118,0.123,0.121,0.122},{0.130,0.133,0.130,0.130},
  {0.142,0.144,0.139,0.139},{0.154,0.155,0.149,0.147},
  {0.170,0.163,0.158,0.155},{0.183,0.172,0.167,0.162},
  {0.195,0.183,0.175,0.171},{0.214,0.201,0.192,0.186},
  {0.225,0.214,0.207,0.199},{0.222,0.218,0.219,0.212},
  {0.184,0.190,0.198,0.206},{0.139,0.145,0.158,0.166}};
  int i,k,l;

  recipsig = 1.0/sig;
  l = 2;
  for(i=0;i<3;i++) {
    if(recipsig < recip[i+1]) {
      l = i;
      break;
    }
  }

  if(w < -2.0) {
    p1 = j[0][l]*4.0/(w*w);
    p2 = j[0][l+1]*4.0/(w*w);
    if(recipsig >= 3.33333) return(p2);
    return(p1 + (p2-p1)*(recipsig-recip[l])/(recip[l+1]-recip[l]));
  }
  if(w > 2.0) {
    p1 = j[16][l]*4.0/(w*w);
    p2 = j[16][l+1]*4.0/(w*w);
    if(recipsig >= 3.33333) return(p2);
    return(p1 + (p2-p1)*(recipsig-recip[l])/(recip[l+1]-recip[l]));
  }
  k = 15;
  for(i=0;i<16;i++) {
    if(w < we[i+1]) {
      k = i;
      break;
    }
  }
  if(recipsig >= 3.33333) {
    p1 = j[k][l+1] + (j[k+1][l+1] - j[k][l+1])*(w-we[k])/(we[k+1]-we[k]);
    return(p1);
  }

  p1 = j[k][l] + (j[k+1][l] - j[k][l])*(w-we[k])/(we[k+1]-we[k]);
  p2 = j[k][l+1] + (j[k+1][l+1] - j[k][l+1])*(w-we[k])/(we[k+1]-we[k]);
  return(p1 + (p2-p1)*(recipsig-recip[l])/(recip[l+1]-recip[l]));
}

double jxas_04(w,sig)
double w,sig;
{
  double p;
  static double we[21] = {-2.0,-1.5,-1.0,-0.7,-0.5,-0.3,-0.2,-0.1,0.0,0.1,0.2,0.3,
  0.5,0.7,1.0,1.5,2.0,2.5,3.0,4.0,5.0};
  static double j[21] = {0.026,0.038,0.056,0.73,0.086,0.104,0.113,0.123,0.131,0.141,
  0.150,0.157,0.170,0.175,0.176,0.160,0.134,0.110,0.090,0.058,0.036};
  int i,k;


  if(w < -2.0) return(j[0]*4.0/(w*w));
  if(w > 5.0)  return(j[20]*25.0/(w*w));
  k = 19;
  for(i=0;i<20;i++) {
    if(w < we[i+1]) {
      k = i;
      break;
    }
  }
  return(j[k] + (j[k+1] - j[k])*(w-we[k])/(we[k+1]-we[k]));
}

double jxas_05(w,sig)
double w,sig;
{
  double p;
  static double we[21] = {-2.0,-1.5,-1.0,-0.7,-0.5,-0.3,-0.2,-0.1,0.0,0.1,0.2,0.3,
  0.5,0.7,1.0,1.5,2.0,2.5,3.0,4.0,5.0};
  static double j[21] = {0.022,0.032,0.047,0.058,0.072,0.090,0.094,0.102,0.110,
  0.117,0.127,0.133,0.144,0.154,0.156,0.148,0.130,0.113,0.096,0.065,0.040};
  int i,k;


  if(w <= -2.0) return(j[0]*4.0/(w*w));
  if(w >= 5.0)  return(j[20]*25.0/(w*w));
  k = 19;
  for(i=0;i<20;i++) {
    if(w < we[i+1]) {
      k = i;
      break;
    }
  }
  return(j[k] + (j[k+1] - j[k])*(w-we[k])/(we[k+1]-we[k]));
}
