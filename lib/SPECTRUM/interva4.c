#include <stdlib.h>
#include <stdio.h>
#include <math.h>
#include <errno.h>
#include "spectrum.h"
double dmin();

/* Opacity Edges (vacuum wavelengths)  */
/* He I        504.259  2600.463  3121.758  3421.856   3679.748  6633.993  
    7437.245  7845.533  8190.596  8192.892  8263.572  12480.412 13567.707 
   14097.159 14564.122 14568.312 14667.150 20146.353  21518.535 22173.139 
   22760.806 22766.705 32780.463 44623.014 58288.416  73776.650 */
/* C I        1101.074  1240.267  1445.663   999.115   3280.088  3467.574
    3740.625  4552.884  4732.397  4980.954  5136.657   5491.579  5936.651
    6424.069  7610.000  7864.449  7923.083  8012.731   7982.801  8136.168
    8271.876  8688.415  9748.893  9962.230  */
/* N I         852.19   1019.17   1129.88  */  
/* O I         911.76  */
/* Mg I        1621.507 2511.262  3756.608  4884.334   5504.278  6549.665
    7291.822   7230.709 8114.056 10205.649 10971.149  11714.567 13473.071
    13371.190  14297.218 14296.776 */ 
/* Mg II       824.63   1169.10  */
/* Al I       1788.804  2071.321  2076.140  4360.982   6312.283  6528.264
    9443.801 10699.50  12496.15  14369.90  */  
/* Si I       1325.842  1514.348  1516.119  1519.483   1520.969  1522.755
    1526.149  1576.131  1674.028  1974.699  1985.972   3834.476  4008.463
    5360.482  5378.946  5625.043  5948.497 */
/* Ca I       2028.153  2928.425  3451.776  3642.149   3898.081  5628.584
    6254.422  7366.212  7838.057  7952.705  8328.013   8652.199  9184.078 */
/* Fe I       1574.803  1680.672  1709.402  1724.138   1739.130  1801.802
    1818.182  1834.862  1851.852  1869.159  2127.660   2222.222  2247.191
    2272.727  2325.581  2380.952  2439.024  2500.000   2631.579  2702.703
    2898.551  2941.176  3076.923  3125.000  3225.806   3278.689  3389.831
    3448.276  3636.364  3703.704  4166.667  4347.826   4761.905 */
/* Si II       600.000   759.608  1905.099  1976.019   3245.247  3576.409  
    3899.999 */ 
/* Ca II      1044.41   1218.61   1420.29  */

/* He I, C I, Mg I and Ca I opacities updated with Opacity Project 
   data for v2.75 */

double interval(wave,dwave,flagf)
double wave,dwave;
int flagf;
{
  static int k = 0;
  static int flag = 0;
  static int nextedge = 0;

  static float edge[155] =
    {  504.259,  600.000,  759.608,  824.63,   852.19,   911.76,   999.115,
      1019.17,  1044.41,  1101.074, 1129.88,  1169.10,  1218.61,  1240.267,
      1325.842, 1420.29,  1445.663, 1514.348, 1516.119, 1519.483, 1520.969,  
      1522.755, 1526.149, 1574.803, 1576.131, 1621.507, 1674.028, 1680.672,
      1709.402, 1724.138, 1739.130, 1788.804, 1801.802, 1818.182, 1834.862,
      1851.852, 1869.159, 1905.099, 1974.699, 1976.019, 1985.972, 2028.153,
      2071.321, 2076.140, 2127.660, 2222.222, 2247.191, 2272.727, 2325.581,
      2380.952, 2439.024, 2500.000, 2511.262, 2600.463, 2631.579, 2702.703,
      2898.551, 2928.425, 2941.176, 3076.923, 3121.758, 3125.000, 3225.806,
      3245.247, 3278.689, 3280.088, 3389.831, 3421.856, 3448.276, 3451.776,
      3467.574, 3576.409, 3636.364, 3642.149, 3679.748, 3703.704, 3740.625,
      3756.608, 3834.476, 3898.081, 3899.999, 4008.463, 4166.667, 4347.826,
      4360.982, 4552.884, 4732.397, 4761.905, 4884.334, 4980.954, 5136.657,
      5360.482, 5378.946, 5491.579, 5504.278, 5625.043, 5628.584, 5936.651,
      5948.497, 6254.422, 6312.283, 6424.069, 6528.264, 6549.665, 6633.993,  
      7230.709, 7291.822, 7366.212, 7437.245, 7610.000, 7838.057, 7845.533,  
      7864.449, 7923.083, 7952.705, 7982.801, 8012.731, 8114.056, 8136.168,
      8190.596, 8192.892, 8263.572, 8271.876, 8328.013, 8652.199, 8688.415,
      9184.078, 9443.801, 9748.893, 9962.230,10205.649,10699.50 ,10971.149,
     11714.567,12480.412,12496.15 ,13371.190,13473.071,13567.707,14097.159, 
     14296.776,14297.218,14369.90 ,14564.122,14568.312,14667.150,20146.353,  
     21518.535,22173.139,22760.806,22766.705,32780.463,44623.014,58288.416,  
     73776.650};
  double DW1,DW2,DW;
  extern memo reset;

  if(reset.interval == 1) {
    k = flag = nextedge = 0;
    reset.interval = 0;
  }

  if(wave > 905.0 && wave < 960.0) return(dwave);
  if(wave > 3645.0 && wave < 3750.0) return(dwave);
  if(wave > 8195.0 && wave < 8210.0) return(dwave);
  if(wave > 73776.65) return(20.0);

  if(flag == 0) {
    flag = 1;
    while(wave > edge[k]) k++;
  }
  if(nextedge == 1) {
    nextedge = 0;
    return(dwave);
  }
  if(flagf == 1) DW1 = 5.0;
  else DW1 = 20.0;

  while(wave > edge[k]) k++;
  DW2 = edge[k] - wave -0.01;
  DW = (double)dmin(DW1,DW2);
  if(DW < DW1) nextedge = 1;
  else nextedge = 0;
  return(DW);
}
